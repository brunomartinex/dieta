<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://placehold.co/180x180/007AFF/ffffff.png?text=Fit+AI">
    <title>FitTracker Dark</title>
    <style>
        /* --- SISTEMA DE CORES (CLARO/ESCURO) --- */
        :root {
            color-scheme: light dark;
            
            /* Cores Base (Modo Claro - Default) */
            --primary: #007AFF;
            --burn: #FF9500;
            --bg: #F2F2F7;
            --card: #FFFFFF;
            --text: #000000;
            --text-sec: #666666;
            --border: #dddddd;
            --input-bg: #FFFFFF;
            --nav-bg: rgba(255,255,255,0.95);
            --danger: #FF3B30;
            --ai-color: #AF52DE;
            --stat-box: #f9f9f9;
        }

        /* Cores Modo Escuro (Ativa automaticamente se o iPhone estiver em Dark Mode) */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #000000;       /* Preto OLED */
                --card: #1C1C1E;     /* Cinza Escuro iOS */
                --text: #FFFFFF;
                --text-sec: #98989D;
                --border: #38383A;
                --input-bg: #2C2C2E;
                --nav-bg: rgba(30,30,30,0.95);
                --stat-box: #2C2C2E;
                --bg-input: #1C1C1E;
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            padding-bottom: 110px;
            color: var(--text);
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.3s, color 0.3s;
        }

        h1, h2, h3 { margin-top: 0; }
        
        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .flex-row { display: flex; justify-content: space-between; align-items: center; }
        .text-center { text-align: center; }
        .hidden { display: none !important; }

        /* Inputs ajustados para Dark Mode */
        input, select, button, textarea {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background-color: var(--input-bg);
            color: var(--text);
            font-size: 16px;
            margin-bottom: 10px;
            box-sizing: border-box;
            font-family: inherit;
        }
        
        /* Remove estilo padr√£o do date picker no iOS para aceitar cores */
        input[type="date"] {
            background-color: var(--input-bg);
            color: var(--text);
            -webkit-appearance: none;
            min-height: 52px; /* Altura fixa para iOS */
        }

        button.primary { background-color: var(--primary); color: white; border: none; font-weight: 600; cursor: pointer; }
        button.burn-btn { background-color: var(--burn); color: white; border: none; font-weight: 600; cursor: pointer; }
        button.ai-btn { background: linear-gradient(135deg, #AF52DE, #5856D6); color: white; border: none; font-weight: 600; }
        
        /* Date Picker Area */
        .date-navigator {
            display: flex; align-items: center; justify-content: space-between;
            background: var(--card); 
            padding: 10px; border-radius: 12px; margin-bottom: 20px; font-weight: bold;
        }
        .date-navigator button { width: auto; margin: 0; padding: 5px 15px; background: none; border: none; color: var(--primary); font-size: 20px; }

        /* Stats Grid */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-box { background: var(--stat-box); padding: 10px; border-radius: 12px; text-align: center; border: 1px solid var(--border); }
        .stat-value { font-size: 20px; font-weight: bold; color: var(--primary); }
        .stat-label { font-size: 11px; color: var(--text-sec); text-transform: uppercase; }
        
        .val-burn { color: var(--burn) !important; }
        
        /* Lista */
        ul { list-style: none; padding: 0; }
        li {
            background: var(--card); 
            border-bottom: 1px solid var(--border); 
            padding: 15px 0;
            display: flex; justify-content: space-between; align-items: center;
        }
        li.type-exercise { 
            background: var(--card);
            border-left: 3px solid var(--burn); 
            padding-left: 10px; 
        }

        /* Nav */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: var(--nav-bg); 
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--border);
            display: flex; justify-content: space-around; padding: 12px 0 25px 0; z-index: 100;
        }
        .nav-item { color: var(--text-sec); font-size: 11px; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center;}
        .nav-item span { font-size: 20px; margin-bottom: 2px; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
    </style>
</head>
<body>

    <div id="page-diary" class="page">
        <div class="date-navigator">
            <button onclick="changeDate(-1)">&#9664;</button>
            <input type="date" id="date-picker" style="text-align:center; font-weight:bold; width:auto; margin:0;" onchange="loadDay()">
            <button onclick="changeDate(1)">&#9654;</button>
        </div>

        <div class="card">
            <div class="flex-row">
                <h2>Balan√ßo do Dia</h2>
            </div>
            
            <div class="stat-grid">
                <div class="stat-box">
                    <div class="stat-value" id="day-cals">0</div>
                    <div class="stat-label">Comida (+)</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value val-burn" id="day-burn">0</div>
                    <div class="stat-label">Treino (-)</div>
                </div>
            </div>
            
            <div style="background:var(--stat-box); padding:10px; border-radius:12px; text-align:center; margin-top:5px; border: 1px solid var(--border);">
                <span style="font-size:12px; color:var(--text-sec);">Saldo L√≠quido (Ingerido - Treino)</span><br>
                <strong style="font-size:24px;" id="day-net">0</strong> <small>kcal</small>
            </div>
        </div>

        <div class="card" style="border: 1px solid var(--ai-color);">
            <h3 style="color: var(--ai-color);">‚ú® IA (Comida)</h3>
            <textarea id="ai-input" rows="1" placeholder="Ex: Bife com arroz"></textarea>
            <button class="ai-btn" id="btn-ask" onclick="askAI()">Registar Comida</button>
            <div id="loading-msg" class="hidden text-center" style="font-size:11px; color:var(--text-sec); margin-top:5px;">A processar...</div>
        </div>

        <div class="card" style="border: 1px solid var(--burn);">
            <h3 style="color: var(--burn);">üèÉ‚Äç‚ôÇÔ∏è Registar Treino</h3>
            <div class="flex-row" style="gap:10px;">
                <input type="text" id="ex-name" placeholder="Ex: Corrida" style="flex:2;">
                <input type="number" id="ex-min" placeholder="Min" style="flex:1;">
            </div>
            <input type="number" id="ex-cals" placeholder="Calorias Ativas (ex: 300)">
            <button class="burn-btn" onclick="addExercise()">Adicionar Treino</button>
        </div>

        <div class="card">
            <h3>Di√°rio de Registos</h3>
            <ul id="daily-list"></ul>
        </div>
    </div>

    <div id="page-stats" class="page hidden">
        <div class="card">
            <h2>Relat√≥rio Semanal</h2>
            <p style="font-size:13px; color:var(--text-sec); margin-bottom:20px;">An√°lise dos √∫ltimos 7 dias.</p>

            <div class="stat-box" style="margin-bottom:15px; border-color: var(--primary);">
                <div class="stat-value" id="week-loss-est">-- kg</div>
                <div class="stat-label">Estimativa Perda Peso</div>
            </div>
            
            <div class="stat-grid">
                <div class="stat-box">
                    <div class="stat-value" id="week-avg-in">0</div>
                    <div class="stat-label">M√©dia Comida</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value val-burn" id="week-avg-burn">0</div>
                    <div class="stat-label">M√©dia Treino</div>
                </div>
            </div>
             <div class="stat-box" style="margin-top:10px;">
                <div class="stat-value" id="week-avg-net">0</div>
                <div class="stat-label">Saldo M√©dio Real</div>
            </div>
        </div>
    </div>

    <div id="page-profile" class="page hidden">
        <div class="card">
            <h2>Configura√ß√£o TDEE</h2>
            <p style="font-size:12px; color:var(--danger); background:rgba(255,59,48,0.1); padding:10px; border-radius:8px;">
                <strong>DICA:</strong> Se registares os treinos manualmente, define a Atividade como <strong>"Sedent√°rio"</strong> aqui.
            </p>
            
            <label>G√©nero:</label>
            <select id="user-gender"><option value="male">Homem</option><option value="female">Mulher</option></select>

            <label>Idade:</label>
            <input type="number" id="user-age">

            <label>Altura (cm):</label>
            <input type="number" id="user-height">
            
            <label>Peso (kg):</label>
            <input type="number" id="user-weight">
            
            <label>N√≠vel de Atividade:</label>
            <select id="user-activity">
                <option value="1.2">Sedent√°rio (Trabalho escrit√≥rio)</option>
                <option value="1.375">Leve (1-3 dias)</option>
                <option value="1.55">Moderado (3-5 dias)</option>
                <option value="1.725">Muito Ativo (6-7 dias)</option>
            </select>

            <button class="primary" onclick="saveProfile()">Guardar Perfil</button>
        </div>

        <div class="card">
            <h3>API Key (Gemini)</h3>
            <input type="password" id="api-key" placeholder="AIza...">
            <button class="primary" onclick="saveKey()">Guardar Chave</button>
            <div id="key-status" style="margin-top:5px; font-size:12px;"></div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchPage('diary')"><span>üìÖ</span>Di√°rio</div>
        <div class="nav-item" onclick="switchPage('stats')"><span>üìä</span>Stats</div>
        <div class="nav-item" onclick="switchPage('profile')"><span>üë§</span>Perfil</div>
    </div>

    <script>
        // --- DADOS V4 (Mant√©m compatibilidade com a tua base de dados) ---
        let currentDate = new Date().toISOString().split('T')[0];
        let allData = JSON.parse(localStorage.getItem('fit_data_v4')) || {}; 
        let user = JSON.parse(localStorage.getItem('fit_user_v4')) || { gender:'male', age:30, height:175, weight:75, activity:1.2 };
        let apiKey = localStorage.getItem('fit_api_key') || '';

        document.getElementById('date-picker').value = currentDate;
        loadProfileUI();
        loadDay();
        updateKeyStatus();

        // --- NAVEGA√á√ÉO ---
        function switchPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById('page-' + page).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if(page === 'diary') document.querySelectorAll('.nav-item')[0].classList.add('active');
            if(page === 'stats') { document.querySelectorAll('.nav-item')[1].classList.add('active'); calculateStats(); }
            if(page === 'profile') document.querySelectorAll('.nav-item')[2].classList.add('active');
        }

        function changeDate(days) {
            const date = new Date(currentDate);
            date.setDate(date.getDate() + days);
            currentDate = date.toISOString().split('T')[0];
            document.getElementById('date-picker').value = currentDate;
            loadDay();
        }

        // --- CORE: CARREGAR DIA ---
        function loadDay() {
            currentDate = document.getElementById('date-picker').value;
            if(!allData[currentDate]) allData[currentDate] = { meals: [], exercises: [] };
            
            const dayData = allData[currentDate];
            const list = document.getElementById('daily-list');
            list.innerHTML = '';
            
            let totalFood = 0;
            let totalBurn = 0;

            // Render Refei√ß√µes
            dayData.meals.forEach((meal, idx) => {
                totalFood += meal.cals;
                list.innerHTML += `
                <li>
                    <div>
                        <strong>${meal.name}</strong><br>
                        <small style="color:var(--text-sec)">üçΩÔ∏è Comida</small>
                    </div>
                    <div style="text-align:right">
                        <strong>+${meal.cals}</strong> kcal
                        <button onclick="deleteItem('meal', ${idx})" style="color:var(--danger); border:none; background:none;">&times;</button>
                    </div>
                </li>`;
            });

            // Render Exerc√≠cios
            dayData.exercises.forEach((ex, idx) => {
                totalBurn += parseInt(ex.cals);
                list.innerHTML += `
                <li class="type-exercise">
                    <div>
                        <strong>${ex.name}</strong><br>
                        <small style="color:var(--burn)">üèÉ‚Äç‚ôÇÔ∏è ${ex.mins} min</small>
                    </div>
                    <div style="text-align:right">
                        <strong style="color:var(--burn)">-${ex.cals}</strong> kcal
                        <button onclick="deleteItem('exercise', ${idx})" style="color:var(--danger); border:none; background:none;">&times;</button>
                    </div>
                </li>`;
            });

            document.getElementById('day-cals').innerText = totalFood;
            document.getElementById('day-burn').innerText = totalBurn;
            document.getElementById('day-net').innerText = (totalFood - totalBurn);
        }

        // --- A√á√ïES ---
        function addExercise() {
            const name = document.getElementById('ex-name').value;
            const mins = document.getElementById('ex-min').value;
            const cals = document.getElementById('ex-cals').value;

            if(name && cals) {
                if(!allData[currentDate]) allData[currentDate] = { meals: [], exercises: [] };
                allData[currentDate].exercises.push({ name, mins, cals: parseInt(cals) });
                saveData();
                document.getElementById('ex-name').value = '';